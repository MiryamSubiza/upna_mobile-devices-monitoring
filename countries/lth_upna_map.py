# -*- coding: utf-8 -*-
"""
@author: Miryam Subiza
"""
from __future__ import division
from pymongo import MongoClient
import pandas as pd
import argparse
import json
import folium
from datetime import datetime
import numpy as np

# Variables globales
maxFecha = None

# Funciones
def obtenerMapa(df, idSensor):
    # 3) Construir un JSON con MCC y número de apariciones
    if not df.empty:
        df = df['MCC'].value_counts()
        numMoviles = df.sum()
        df = df.rename_axis('MCC').reset_index(name='mcc_count')
        df['mcc_percentage'] = df.apply(lambda x: round(x['mcc_count']/df['mcc_count'].sum()*100,2) if (x['mcc_count']/4000165*100 >= 0.01) else round(x['mcc_count']/4000165*100,3), axis=1)
        df.MCC = df.MCC.apply(int)
        # 4) Unir datos en un mismo DataFrame para tener la información de los MCC
        df = df_country.join(df.set_index('MCC'), on='MCC')
        df.mcc_count = df.mcc_count.fillna(0)
        df.mcc_count = df.mcc_count.apply(int)
        df.mcc_percentage = df.mcc_percentage.fillna(0)
        df.mcc_percentage = df.mcc_percentage.apply(float)
    else:
        df = pd.DataFrame(columns = ['MCC','mcc_count','mcc_percentage'])
        numMoviles = 0
    
    # 5) Construir mapa
    # Crear plantilla
    m = folium.Map(location=[51.014905, 14.241926], tiles="OpenStreetMap", zoom_start=4)
    # Si hay datos, añadir burbujas
    for i in range(0,len(df)):
        if df.iloc[i]['mcc_count'] > 0:
            if df.iloc[i]['COUNTRY'] == 'Spain':
                radio = 350000
            else:
                if df.iloc[i]['mcc_percentage'] >= 25: # Entre 25 y 100
                    radio = float(df.iloc[i]['mcc_percentage']*6000)
                elif df.iloc[i]['mcc_percentage'] < 25 and df.iloc[i]['mcc_percentage'] >= 10: # Entre 10 y 25
                    radio = 125000
                elif df.iloc[i]['mcc_percentage'] < 10 and df.iloc[i]['mcc_percentage'] >= 5: # Entre 5 y 10
                    radio = 110000
                elif df.iloc[i]['mcc_percentage'] < 5 and df.iloc[i]['mcc_percentage'] >= 1: # Entre 1 y 5
                    radio = 100000
                elif df.iloc[i]['mcc_percentage'] < 1 and df.iloc[i]['mcc_percentage'] >= 0.5: # Entre 0.5 y 1
                    radio = 75000
                elif df.iloc[i]['mcc_percentage'] < 0.5 and df.iloc[i]['mcc_percentage'] >= 0.25: # Entre 0.25 y 0.50
                    radio = 65000
                else: # Entre 0 y 0.25
                    radio = 50000
            if df.iloc[i]['mcc_percentage'] >= 0.0005:
                popupText = df.iloc[i]['PAIS'] + ": " + str(df.iloc[i]['mcc_percentage']) + "%"
            else:
                popupText = df.iloc[i]['PAIS'] + ": < 0.0005%"
            folium.Circle(
                location=[df.iloc[i]['LAT'], df.iloc[i]['LON']],
                popup=popupText,
                radius=radio,
                color='crimson',
                fill=True,
                fill_color='crimson'
            ).add_to(m)
    
    # Añadir título
    if maxFecha:
        d = datetime.strptime(maxFecha, "%Y-%m-%dT%H:%M:%S.%fZ")
    else:
        d = datetime.today()
    
    f = folium.Figure()
    f.html.add_child(folium.Element(u"<h5 class='text-center'><strong>Número de móviles por países</strong>  ("+ d.strftime('%d/%m/%Y - %H:%Mh') +")   -   " + str(numMoviles) + "</h5>"))
    f.add_child(m)
    
    # Guardar como html
    if idSensor:
        f.save('lth_upna_map_' + idSensor + '.html')
    else:
        f.save('lth_upna_map.html')
# FIN FUNCIONES
    

# Leer argumentos recibidos por parámetro al ejecutar el script (credenciales BBDD)
parser = argparse.ArgumentParser()
parser.add_argument('--u', help='filename help') # Username
parser.add_argument('--p', help='filename help') # Password
args = parser.parse_args()
if not args.u or not args.p:
    print("Para ejecutar el script: python lth_upna_map.py --u=USERNAME --p=PASSWORD")
    exit()

# 1) Cargar coordenadas de países (Pendiente cambiarlo por una consulta a la BBDD)
d1 = json.loads('{"0": {"COUNTRY": "Afghanistan", "PAIS": "Afganistan", "CAPITAL": "Kabul", "LAT": "34,5167", "LON": "69,1833", "MCC": 412}, "1": {"COUNTRY": "Albania", "PAIS": "Albania", "CAPITAL": "Tirana", "LAT": "41,3275", "LON": "19,8189", "MCC": 276}, "2": {"COUNTRY": "Algeria", "PAIS": "Argelia", "CAPITAL": "Algiers", "LAT": "36,7631", "LON": "3,0506", "MCC": 603}, "3": {"COUNTRY": "Andorra", "PAIS": "Andorra", "CAPITAL": "Andorra", "LAT": "42,5", "LON": "1,5165", "MCC": 213}, "4": {"COUNTRY": "Angola", "PAIS": "Angola", "CAPITAL": "Luanda", "LAT": "-8,8383", "LON": "13,2344", "MCC": 631}, "5": {"COUNTRY": "Anguilla", "PAIS": "Anguila", "CAPITAL": "The Valley", "LAT": "18,2167", "LON": "-63,05", "MCC": 365}, "6": {"COUNTRY": "Antigua and Barbuda", "PAIS": "Antigua y Barbuda", "CAPITAL": "Saint John\'s", "LAT": "17,118", "LON": "-61,85", "MCC": 344}, "7": {"COUNTRY": "Argentina", "PAIS": "Argentina", "CAPITAL": "Buenos Aires", "LAT": "-34,6025", "LON": "-58,3975", "MCC": 722}, "8": {"COUNTRY": "Armenia", "PAIS": "Armenia", "CAPITAL": "Yerevan", "LAT": "40,1812", "LON": "44,5136", "MCC": 283}, "9": {"COUNTRY": "Aruba", "PAIS": "Aruba", "CAPITAL": "Oranjestad", "LAT": "12,5304", "LON": "-70,029", "MCC": 363}, "10": {"COUNTRY": "Australia", "PAIS": "Australia", "CAPITAL": "Canberra", "LAT": "-35,283", "LON": "149,129", "MCC": 505}, "11": {"COUNTRY": "Austria", "PAIS": "Austria", "CAPITAL": "Vienna", "LAT": "48,2", "LON": "16,3666", "MCC": 232}, "12": {"COUNTRY": "Azerbaijan", "PAIS": "Azerbaiy\u00e1n", "CAPITAL": "Baku", "LAT": "40,3953", "LON": "49,8622", "MCC": 400}, "13": {"COUNTRY": "Bahrain", "PAIS": "Bar\u00e9in", "CAPITAL": "Manama", "LAT": "26,2361", "LON": "50,5831", "MCC": 426}, "14": {"COUNTRY": "Bangladesh", "PAIS": "Banglad\u00e9s", "CAPITAL": "Dhaka", "LAT": "23,7231", "LON": "90,4086", "MCC": 470}, "15": {"COUNTRY": "Barbados", "PAIS": "Barbados", "CAPITAL": "Bridgetown", "LAT": "13,102", "LON": "-59,6165", "MCC": 342}, "16": {"COUNTRY": "Belarus", "PAIS": "Bielorusia", "CAPITAL": "Minsk", "LAT": "53,9", "LON": "27,5666", "MCC": 257}, "17": {"COUNTRY": "Belgium", "PAIS": "B\u00e9lgica", "CAPITAL": "Brussels", "LAT": "50,8333", "LON": "4,3333", "MCC": 206}, "18": {"COUNTRY": "Belize", "PAIS": "Belice", "CAPITAL": "Belmopan", "LAT": "17,252", "LON": "-88,7671", "MCC": 702}, "19": {"COUNTRY": "Benin", "PAIS": "Ben\u00edn", "CAPITAL": "Porto-Novo", "LAT": "6,4833", "LON": "2,6166", "MCC": 616}, "20": {"COUNTRY": "Bhutan", "PAIS": "But\u00e1n", "CAPITAL": "Thimphu", "LAT": "27,473", "LON": "89,639", "MCC": 402}, "21": {"COUNTRY": "Bosnia and Herzegovina", "PAIS": "Bosnia y Herzegovina", "CAPITAL": "Sarajevo", "LAT": "43,85", "LON": "18,383", "MCC": 218}, "22": {"COUNTRY": "Botswana", "PAIS": "Botsuana", "CAPITAL": "Gaborone", "LAT": "-24,6463", "LON": "25,9119", "MCC": 652}, "23": {"COUNTRY": "Bolivia", "PAIS": "Bolivia", "CAPITAL": "La Paz", "LAT": "-16,498", "LON": "-68,15", "MCC": 736}, "24": {"COUNTRY": "Brazil", "PAIS": "Brasil", "CAPITAL": "Bras\u00edlia", "LAT": "-15,7833", "LON": "-47,9161", "MCC": 724}, "25": {"COUNTRY": "Virgin Islands, British", "PAIS": "Islas V\u00edrgenes", "CAPITAL": "Road Town", "LAT": "18,4167", "LON": "-64,6167", "MCC": 348}, "26": {"COUNTRY": "Brunei", "PAIS": "Brun\u00e9i", "CAPITAL": "Bandar Seri Begawan", "LAT": "4,8833", "LON": "114,9333", "MCC": 528}, "27": {"COUNTRY": "Bulgaria", "PAIS": "Bulgaria", "CAPITAL": "Sofia", "LAT": "42,6833", "LON": "23,3167", "MCC": 284}, "28": {"COUNTRY": "Burkina Faso", "PAIS": "Burkina Faso", "CAPITAL": "Ouagadougou", "LAT": "12,3703", "LON": "-1,5247", "MCC": 613}, "29": {"COUNTRY": "Burundi", "PAIS": "Burundi", "CAPITAL": "Bujumbura", "LAT": "-3,3761", "LON": "29,36", "MCC": 642}, "30": {"COUNTRY": "Cambodia", "PAIS": "Camboya", "CAPITAL": "Phnom Penh", "LAT": "11,55", "LON": "104,9166", "MCC": 456}, "31": {"COUNTRY": "Cameroon", "PAIS": "Camer\u00fan", "CAPITAL": "Yaounde", "LAT": "3,8667", "LON": "11,5167", "MCC": 624}, "32": {"COUNTRY": "Canada", "PAIS": "Canad\u00e1", "CAPITAL": "Ottawa", "LAT": "45,4167", "LON": "-75,7", "MCC": 302}, "33": {"COUNTRY": "Cabo Verde", "PAIS": "Cabo Verde", "CAPITAL": "Praia", "LAT": "14,9167", "LON": "-23,5167", "MCC": 625}, "34": {"COUNTRY": "Cayman Islands", "PAIS": "Islas Caim\u00e1n", "CAPITAL": "George Town", "LAT": "19,2804", "LON": "-81,33", "MCC": 346}, "35": {"COUNTRY": "Central African Republic", "PAIS": "Rep\u00fablica Centroafricana", "CAPITAL": "Bangui", "LAT": "4,3666", "LON": "18,5583", "MCC": 623}, "36": {"COUNTRY": "Chad", "PAIS": "Chad", "CAPITAL": "Ndjamena", "LAT": "12,1131", "LON": "15,0491", "MCC": 622}, "37": {"COUNTRY": "Czechia", "PAIS": "Rep\u00fablica Checa", "CAPITAL": "Prague", "LAT": "50,0833", "LON": "14,466", "MCC": 230}, "38": {"COUNTRY": "Chile", "PAIS": "Chile", "CAPITAL": "Santiago", "LAT": "-33,45", "LON": "-70,667", "MCC": 730}, "39": {"COUNTRY": "China", "PAIS": "Rep\u00fablica Popular China", "CAPITAL": "Beijing", "LAT": "39,9289", "LON": "116,3883", "MCC": 460}, "40": {"COUNTRY": "Cyprus", "PAIS": "Chipre", "CAPITAL": "Nicosia", "LAT": "35,1667", "LON": "33,3666", "MCC": 280}, "41": {"COUNTRY": "Colombia", "PAIS": "Colombia", "CAPITAL": "Bogota", "LAT": "4,5964", "LON": "-74,0833", "MCC": 732}, "42": {"COUNTRY": "Comoros", "PAIS": "Comoras", "CAPITAL": "Moroni", "LAT": "-11,7042", "LON": "43,2402", "MCC": 654}, "43": {"COUNTRY": "Congo", "PAIS": "Rep\u00fablica del Congo", "CAPITAL": "Brazzaville", "LAT": "-4,2592", "LON": "15,2847", "MCC": 629}, "44": {"COUNTRY": "Democratic Republic of the Congo", "PAIS": "Rep\u00fablica Democr\u00e1tica del Congo", "CAPITAL": "Kinshasa", "LAT": "-4,3297", "LON": "15,315", "MCC": 630}, "45": {"COUNTRY": "Cook Islands", "PAIS": "Islas Cook", "CAPITAL": "Avarua", "LAT": "-21,25", "LON": "-159,75", "MCC": 548}, "46": {"COUNTRY": "Costa Rica", "PAIS": "Costa Rica", "CAPITAL": "San Jos\u00e9", "LAT": "9,935", "LON": "-84,0841", "MCC": 712}, "47": {"COUNTRY": "Croatia", "PAIS": "Croacia", "CAPITAL": "Zagreb", "LAT": "45,8", "LON": "16", "MCC": 219}, "48": {"COUNTRY": "Cuba", "PAIS": "Cuba", "CAPITAL": "Havana", "LAT": "23,132", "LON": "-82,3642", "MCC": 368}, "49": {"COUNTRY": "Denmark", "PAIS": "Dinamarca", "CAPITAL": "K\u00f8benhavn", "LAT": "55,6786", "LON": "12,5635", "MCC": 238}, "50": {"COUNTRY": "Djibouti", "PAIS": "Yibuti", "CAPITAL": "Djibouti", "LAT": "11,595", "LON": "43,148", "MCC": 638}, "51": {"COUNTRY": "Dominican Republic", "PAIS": "Rep\u00fablica Dominicana", "CAPITAL": "Santo Domingo", "LAT": "18,4701", "LON": "-69,9001", "MCC": 370}, "52": {"COUNTRY": "Ecuador", "PAIS": "Ecuador", "CAPITAL": "Quito", "LAT": "-0,215", "LON": "-78,5001", "MCC": 740}, "53": {"COUNTRY": "Egypt", "PAIS": "Egipto", "CAPITAL": "Cairo", "LAT": "30,05", "LON": "31,25", "MCC": 602}, "54": {"COUNTRY": "El Salvador", "PAIS": "El Salvador", "CAPITAL": "San Salvador", "LAT": "13,71", "LON": "-89,203", "MCC": 706}, "55": {"COUNTRY": "Spain", "PAIS": "Espa\u00f1a", "CAPITAL": "Madrid", "LAT": "40,4", "LON": "-3,6834", "MCC": 214}, "56": {"COUNTRY": "Estonia", "PAIS": "Estonia", "CAPITAL": "Tallinn", "LAT": "59,4339", "LON": "24,728", "MCC": 248}, "57": {"COUNTRY": "Ethiopia", "PAIS": "Etiop\u00eda", "CAPITAL": "Addis Ababa", "LAT": "9,0333", "LON": "38,7", "MCC": 636}, "58": {"COUNTRY": "Faroe Islands", "PAIS": "Islas Feroe", "CAPITAL": "T\u00f3rshavn", "LAT": "62,03", "LON": "-6,82", "MCC": 288}, "59": {"COUNTRY": "Fiji", "PAIS": "Fiyi", "CAPITAL": "Suva", "LAT": "-18,133", "LON": "178,4417", "MCC": 542}, "60": {"COUNTRY": "Finland", "PAIS": "Finlandia", "CAPITAL": "Helsinki", "LAT": "60,1756", "LON": "24,9341", "MCC": 244}, "61": {"COUNTRY": "France", "PAIS": "Francia", "CAPITAL": "Paris", "LAT": "48,8667", "LON": "2,3333", "MCC": 208}, "62": {"COUNTRY": "French Polynesia", "PAIS": "Polinesia Francesa", "CAPITAL": "Papeete", "LAT": "-17,5334", "LON": "-149,5667", "MCC": 547}, "63": {"COUNTRY": "Gabon", "PAIS": "Gab\u00f3n", "CAPITAL": "Libreville", "LAT": "0,3854", "LON": "9,458", "MCC": 628}, "64": {"COUNTRY": "Gambia", "PAIS": "Gambia", "CAPITAL": "Banjul", "LAT": "13,4539", "LON": "-16,5917", "MCC": 607}, "65": {"COUNTRY": "Georgia", "PAIS": "Georgia", "CAPITAL": "Tbilisi", "LAT": "41,725", "LON": "44,7908", "MCC": 282}, "66": {"COUNTRY": "Germany", "PAIS": "Alemania", "CAPITAL": "Berlin", "LAT": "52,5218", "LON": "13,4015", "MCC": 262}, "67": {"COUNTRY": "Ghana", "PAIS": "Ghana", "CAPITAL": "Accra", "LAT": "5,55", "LON": "-0,2167", "MCC": 620}, "68": {"COUNTRY": "Gibraltar", "PAIS": "Gibraltar", "CAPITAL": "Gibraltar", "LAT": "36,1324", "LON": "-5,3781", "MCC": 266}, "69": {"COUNTRY": "Greece", "PAIS": "Grecia", "CAPITAL": "Athens", "LAT": "37,9833", "LON": "23,7333", "MCC": 202}, "70": {"COUNTRY": "Grenada", "PAIS": "Groenlandia", "CAPITAL": "Saint George\'s", "LAT": "12,0526", "LON": "-61,7416", "MCC": 290}, "71": {"COUNTRY": "Guadeloupe", "PAIS": "Guadalupe", "CAPITAL": "Basseterre", "LAT": "17,302", "LON": "-62,717", "MCC": 340}, "72": {"COUNTRY": "Guatemala", "PAIS": "Guatemala", "CAPITAL": "Guatemala", "LAT": "14,6211", "LON": "-90,527", "MCC": 704}, "73": {"COUNTRY": "Guinea", "PAIS": "Guinea", "CAPITAL": "Conakry", "LAT": "9,5315", "LON": "-13,6802", "MCC": 611}, "74": {"COUNTRY": "Guinea-Bissau", "PAIS": "Guinea-Bissau", "CAPITAL": "Bissau", "LAT": "11,865", "LON": "-15,5984", "MCC": 632}, "75": {"COUNTRY": "Guyana", "PAIS": "Guayana", "CAPITAL": "Georgetown", "LAT": "6,802", "LON": "-58,167", "MCC": 738}, "76": {"COUNTRY": "Honduras", "PAIS": "Honduras", "CAPITAL": "Tegucigalpa", "LAT": "14,102", "LON": "-87,2175", "MCC": 708}, "77": {"COUNTRY": "Hungary", "PAIS": "Hungr\u00eda", "CAPITAL": "Budapest", "LAT": "47,5", "LON": "19,0833", "MCC": 216}, "78": {"COUNTRY": "Iceland", "PAIS": "Islandia", "CAPITAL": "Reykjav\u00edk", "LAT": "64,15", "LON": "-21,95", "MCC": 274}, "79": {"COUNTRY": "India", "PAIS": "India", "CAPITAL": "New Delhi", "LAT": "28,6", "LON": "77,2", "MCC": 404}, "80": {"COUNTRY": "Indonesia", "PAIS": "Indonesia", "CAPITAL": "Jakarta", "LAT": "-6,1744", "LON": "106,8294", "MCC": 510}, "81": {"COUNTRY": "Iran", "PAIS": "Ir\u00e1n", "CAPITAL": "Tehran", "LAT": "35,6719", "LON": "51,4243", "MCC": 432}, "82": {"COUNTRY": "Iraq", "PAIS": "Irak", "CAPITAL": "Baghdad", "LAT": "33,3386", "LON": "44,3939", "MCC": 418}, "83": {"COUNTRY": "Ireland", "PAIS": "Irlanda", "CAPITAL": "Dublin", "LAT": "53,3331", "LON": "-6,2489", "MCC": 272}, "84": {"COUNTRY": "Israel", "PAIS": "Israel", "CAPITAL": "Jerusalem", "LAT": "31,7784", "LON": "35,2066", "MCC": 425}, "85": {"COUNTRY": "Italy", "PAIS": "Italia", "CAPITAL": "Rome", "LAT": "41,896", "LON": "12,4833", "MCC": 222}, "86": {"COUNTRY": "Cote d\'Ivoire", "PAIS": "Costa de Marfil", "CAPITAL": "Yamoussoukro", "LAT": "6,8184", "LON": "-5,2755", "MCC": 612}, "87": {"COUNTRY": "Jamaica", "PAIS": "Jamaica", "CAPITAL": "Kingston", "LAT": "17,9771", "LON": "-76,7674", "MCC": 338}, "88": {"COUNTRY": "Japan", "PAIS": "Jap\u00f3n", "CAPITAL": "Tokyo", "LAT": "35,685", "LON": "139,7514", "MCC": 440}, "89": {"COUNTRY": "Jordan", "PAIS": "Jordania", "CAPITAL": "Amman", "LAT": "31,95", "LON": "35,9333", "MCC": 416}, "90": {"COUNTRY": "Kazakhstan", "PAIS": "Kazajist\u00e1n", "CAPITAL": "Astana", "LAT": "51,1811", "LON": "71,4278", "MCC": 401}, "91": {"COUNTRY": "Kenya", "PAIS": "Kenia", "CAPITAL": "Nairobi", "LAT": "-1,2833", "LON": "36,8167", "MCC": 639}, "92": {"COUNTRY": "South Korea", "PAIS": "Corea del Sur", "CAPITAL": "Seoul", "LAT": "37,5663", "LON": "126,9997", "MCC": 450}, "93": {"COUNTRY": "Kuwait", "PAIS": "Kuwait", "CAPITAL": "Kuwait", "LAT": "29,3697", "LON": "47,9783", "MCC": 419}, "94": {"COUNTRY": "Kyrgyzstan", "PAIS": "Kirguist\u00e1n", "CAPITAL": "Bishkek", "LAT": "42,8731", "LON": "74,5852", "MCC": 437}, "95": {"COUNTRY": "Laos", "PAIS": "Laos", "CAPITAL": "Vientiane", "LAT": "17,9667", "LON": "102,6", "MCC": 457}, "96": {"COUNTRY": "Latvia", "PAIS": "Letonia", "CAPITAL": "Riga", "LAT": "56,95", "LON": "24,1", "MCC": 247}, "97": {"COUNTRY": "Lebanon", "PAIS": "L\u00edbano", "CAPITAL": "Beirut", "LAT": "33,872", "LON": "35,5097", "MCC": 415}, "98": {"COUNTRY": "Lesotho", "PAIS": "Lesoto", "CAPITAL": "Maseru", "LAT": "-29,3167", "LON": "27,4833", "MCC": 651}, "99": {"COUNTRY": "Liberia", "PAIS": "Liberia", "CAPITAL": "Monrovia", "LAT": "6,3106", "LON": "-10,8048", "MCC": 618}, "100": {"COUNTRY": "Libya", "PAIS": "Libia", "CAPITAL": "Tripoli", "LAT": "32,8925", "LON": "13,18", "MCC": 606}, "101": {"COUNTRY": "Liechtenstein", "PAIS": "Liechtenstein", "CAPITAL": "Vaduz", "LAT": "47,1337", "LON": "9,5167", "MCC": 295}, "102": {"COUNTRY": "Lithuania", "PAIS": "Lituania", "CAPITAL": "Vilnius", "LAT": "54,6834", "LON": "25,3166", "MCC": 246}, "103": {"COUNTRY": "Luxembourg", "PAIS": "Luxemburgo", "CAPITAL": "Luxembourg", "LAT": "49,6117", "LON": "6,13", "MCC": 270}, "104": {"COUNTRY": "Macedonia", "PAIS": "Rep\u00fablica de Macedonia", "CAPITAL": "Skopje", "LAT": "42", "LON": "21,4335", "MCC": 294}, "105": {"COUNTRY": "Madagascar", "PAIS": "Madagascar", "CAPITAL": "Antananarivo", "LAT": "-18,9166", "LON": "47,5166", "MCC": 646}, "106": {"COUNTRY": "Malawi", "PAIS": "Malaui", "CAPITAL": "Lilongwe", "LAT": "-13,9833", "LON": "33,7833", "MCC": 650}, "107": {"COUNTRY": "Malaysia", "PAIS": "Malasia", "CAPITAL": "Kuala Lumpur", "LAT": "3,1667", "LON": "101,7", "MCC": 502}, "108": {"COUNTRY": "Maldives", "PAIS": "Maldivas", "CAPITAL": "Mal\u00e9", "LAT": "4,1667", "LON": "73,4999", "MCC": 472}, "109": {"COUNTRY": "Mali", "PAIS": "Mal\u00ed", "CAPITAL": "Bamako", "LAT": "12,65", "LON": "-8", "MCC": 610}, "110": {"COUNTRY": "Malta", "PAIS": "Malta", "CAPITAL": "Valletta", "LAT": "35,8997", "LON": "14,5147", "MCC": 278}, "111": {"COUNTRY": "Mauritania", "PAIS": "Mauritania", "CAPITAL": "Nouakchott", "LAT": "18,0864", "LON": "-15,9753", "MCC": 609}, "112": {"COUNTRY": "Mauritius", "PAIS": "Mauricio", "CAPITAL": "Port Louis", "LAT": "-20,1666", "LON": "57,5", "MCC": 617}, "113": {"COUNTRY": "Mexico", "PAIS": "Mexico", "CAPITAL": "Mexico City", "LAT": "19,4424", "LON": "-99,131", "MCC": 334}, "114": {"COUNTRY": "Federated States Of Micronesia", "PAIS": "Estados Federados de Micronesia", "CAPITAL": "Palikir", "LAT": "6,9166", "LON": "158,15", "MCC": 550}, "115": {"COUNTRY": "Moldova", "PAIS": "Moldavia", "CAPITAL": "Chi\u0219in\u0103u", "LAT": "47,005", "LON": "28,8577", "MCC": 259}, "116": {"COUNTRY": "Mongolia", "PAIS": "Mongolia", "CAPITAL": "Ulaanbaatar", "LAT": "47,9167", "LON": "106,9166", "MCC": 428}, "117": {"COUNTRY": "Montenegro", "PAIS": "Montenegro", "CAPITAL": "Podgorica", "LAT": "42,466", "LON": "19,2663", "MCC": 297}, "118": {"COUNTRY": "Morocco", "PAIS": "Marruecos", "CAPITAL": "Rabat", "LAT": "34,0253", "LON": "-6,8361", "MCC": 604}, "119": {"COUNTRY": "Mozambique", "PAIS": "Mozambique", "CAPITAL": "Maputo", "LAT": "-25,9553", "LON": "32,5892", "MCC": 643}, "120": {"COUNTRY": "Burma", "PAIS": "Birmania", "CAPITAL": "Rangoon", "LAT": "16,7834", "LON": "96,1667", "MCC": 414}, "121": {"COUNTRY": "Namibia", "PAIS": "Namibia", "CAPITAL": "Windhoek", "LAT": "-22,57", "LON": "17,0835", "MCC": 649}, "122": {"COUNTRY": "Nepal", "PAIS": "Nepal", "CAPITAL": "Kathmandu", "LAT": "27,7167", "LON": "85,3166", "MCC": 429}, "123": {"COUNTRY": "Netherlands", "PAIS": "Paises Bajos", "CAPITAL": "Amsterdam", "LAT": "52,35", "LON": "4,9166", "MCC": 204}, "124": {"COUNTRY": "New Caledonia", "PAIS": "Nueva Caledonia", "CAPITAL": "Noum\u00e9a", "LAT": "-22,2625", "LON": "166,4443", "MCC": 546}, "125": {"COUNTRY": "New Zealand", "PAIS": "Nueva Zelanda", "CAPITAL": "Wellington", "LAT": "-41,3", "LON": "174,7833", "MCC": 530}, "126": {"COUNTRY": "Nicaragua", "PAIS": "Nicaragua", "CAPITAL": "Managua", "LAT": "12,153", "LON": "-86,2685", "MCC": 710}, "127": {"COUNTRY": "Niger", "PAIS": "N\u00edger", "CAPITAL": "Niamey", "LAT": "13,5167", "LON": "2,1167", "MCC": 614}, "128": {"COUNTRY": "Nigeria", "PAIS": "Nigeria", "CAPITAL": "Abuja", "LAT": "9,0833", "LON": "7,5333", "MCC": 621}, "129": {"COUNTRY": "Norway", "PAIS": "Noruega", "CAPITAL": "Oslo", "LAT": "59,9167", "LON": "10,75", "MCC": 242}, "130": {"COUNTRY": "Oman", "PAIS": "Om\u00e1n", "CAPITAL": "Muscat", "LAT": "23,6133", "LON": "58,5933", "MCC": 422}, "131": {"COUNTRY": "Pakistan", "PAIS": "Pakist\u00e1n", "CAPITAL": "Islamabad", "LAT": "33,7", "LON": "73,1666", "MCC": 410}, "132": {"COUNTRY": "Palau", "PAIS": "Palaos", "CAPITAL": "Ngerulmud", "LAT": "7,5", "LON": "134,6242", "MCC": 552}, "133": {"COUNTRY": "Panama", "PAIS": "Panam\u00e1", "CAPITAL": "Panama City", "LAT": "8,968", "LON": "-79,533", "MCC": 714}, "134": {"COUNTRY": "Paraguay", "PAIS": "Paraguay", "CAPITAL": "Asunci\u00f3n", "LAT": "-25,2964", "LON": "-57,6415", "MCC": 744}, "135": {"COUNTRY": "Peru", "PAIS": "Per\u00fa", "CAPITAL": "Lima", "LAT": "-12,048", "LON": "-77,0501", "MCC": 716}, "136": {"COUNTRY": "Philippines", "PAIS": "Filipinas", "CAPITAL": "Manila", "LAT": "14,6042", "LON": "120,9822", "MCC": 515}, "137": {"COUNTRY": "Poland", "PAIS": "Polonia", "CAPITAL": "Warsaw", "LAT": "52,25", "LON": "21", "MCC": 260}, "138": {"COUNTRY": "Portugal", "PAIS": "Portugal", "CAPITAL": "Lisbon", "LAT": "38,7227", "LON": "-9,1449", "MCC": 268}, "139": {"COUNTRY": "Qatar", "PAIS": "Catar", "CAPITAL": "Doha", "LAT": "25,2866", "LON": "51,533", "MCC": 427}, "140": {"COUNTRY": "Reunion", "PAIS": "Reuni\u00f3n", "CAPITAL": "Saint-Denis", "LAT": "-20,8789", "LON": "55,4481", "MCC": 647}, "141": {"COUNTRY": "Romania", "PAIS": "Rumania", "CAPITAL": "Bucharest", "LAT": "44,4334", "LON": "26,0999", "MCC": 226}, "142": {"COUNTRY": "Russia", "PAIS": "Rusia", "CAPITAL": "Moscow", "LAT": "55,7522", "LON": "37,6155", "MCC": 250}, "143": {"COUNTRY": "Rwanda", "PAIS": "Ruanda", "CAPITAL": "Kigali", "LAT": "-1,9536", "LON": "30,0605", "MCC": 635}, "144": {"COUNTRY": "Samoa", "PAIS": "Samoa", "CAPITAL": "Apia", "LAT": "-13,8415", "LON": "-171,7386", "MCC": 549}, "145": {"COUNTRY": "San Marino", "PAIS": "San Marino", "CAPITAL": "San Marino", "LAT": "43,9172", "LON": "12,4667", "MCC": 292}, "146": {"COUNTRY": "Saint Pierre and Miquelon", "PAIS": "San Pedro y Miquel\u00f3n", "CAPITAL": "Saint-Pierre", "LAT": "46,7811", "LON": "-56,1764", "MCC": 308}, "147": {"COUNTRY": "Sao Tome and Principe", "PAIS": "Santo Tom\u00e9 y Pr\u00edncipe", "CAPITAL": "S\u00e3o Tom\u00e9", "LAT": "0,3334", "LON": "6,7333", "MCC": 626}, "148": {"COUNTRY": "Saudi Arabia", "PAIS": "Arabia Saudita", "CAPITAL": "Riyadh", "LAT": "24,6408", "LON": "46,7727", "MCC": 420}, "149": {"COUNTRY": "Senegal", "PAIS": "Senegal", "CAPITAL": "Dakar", "LAT": "14,7158", "LON": "-17,4731", "MCC": 608}, "150": {"COUNTRY": "Serbia", "PAIS": "Serbia", "CAPITAL": "Belgrade", "LAT": "44,8186", "LON": "20,468", "MCC": 220}, "151": {"COUNTRY": "Seychelles", "PAIS": "Seychelles", "CAPITAL": "Victoria", "LAT": "-4,6166", "LON": "55,45", "MCC": 633}, "152": {"COUNTRY": "Sierra Leone", "PAIS": "Sierra Leona", "CAPITAL": "Freetown", "LAT": "8,47", "LON": "-13,2342", "MCC": 619}, "153": {"COUNTRY": "Singapore", "PAIS": "Singapur", "CAPITAL": "Singapore", "LAT": "1,293", "LON": "103,8558", "MCC": 525}, "154": {"COUNTRY": "Slovakia", "PAIS": "Eslovaquia", "CAPITAL": "Bratislava", "LAT": "48,15", "LON": "17,117", "MCC": 231}, "155": {"COUNTRY": "Slovenia", "PAIS": "Eslovenia", "CAPITAL": "Ljubljana", "LAT": "46,0553", "LON": "14,515", "MCC": 293}, "156": {"COUNTRY": "South Africa", "PAIS": "Sud\u00e1frica", "CAPITAL": "Pretoria", "LAT": "-25,7069", "LON": "28,2294", "MCC": 655}, "157": {"COUNTRY": "Sri Lanka", "PAIS": "Sri Lanka", "CAPITAL": "Colombo", "LAT": "6,932", "LON": "79,8578", "MCC": 413}, "158": {"COUNTRY": "Sudan", "PAIS": "Sud\u00e1n", "CAPITAL": "Khartoum", "LAT": "15,5881", "LON": "32,5342", "MCC": 634}, "159": {"COUNTRY": "Suriname", "PAIS": "Surinam", "CAPITAL": "Paramaribo", "LAT": "5,835", "LON": "-55,167", "MCC": 746}, "160": {"COUNTRY": "Swaziland", "PAIS": "Swazilandia", "CAPITAL": "Mbabane", "LAT": "-26,3167", "LON": "31,1333", "MCC": 653}, "161": {"COUNTRY": "Sweden", "PAIS": "Suecia", "CAPITAL": "Stockholm", "LAT": "59,3508", "LON": "18,0973", "MCC": 240}, "162": {"COUNTRY": "Switzerland", "PAIS": "Suiza", "CAPITAL": "Bern", "LAT": "46,9167", "LON": "7,467", "MCC": 228}, "163": {"COUNTRY": "Syria", "PAIS": "Siria", "CAPITAL": "Damascus", "LAT": "33,5", "LON": "36,3", "MCC": 417}, "164": {"COUNTRY": "Tajikistan", "PAIS": "Tayikist\u00e1n", "CAPITAL": "Dushanbe", "LAT": "38,56", "LON": "68,7739", "MCC": 436}, "165": {"COUNTRY": "Taiwan", "PAIS": "Rep\u00fablica de China", "CAPITAL": "Taipei", "LAT": "25,0358", "LON": "121,5683", "MCC": 466}, "166": {"COUNTRY": "Tanzania", "PAIS": "Tanzania", "CAPITAL": "Dodoma", "LAT": "-6,1833", "LON": "35,75", "MCC": 640}, "167": {"COUNTRY": "Thailand", "PAIS": "Tailandia", "CAPITAL": "Bangkok", "LAT": "13,75", "LON": "100,5166", "MCC": 520}, "168": {"COUNTRY": "Togo", "PAIS": "Togo", "CAPITAL": "Lom\u00e9", "LAT": "6,1319", "LON": "1,2228", "MCC": 615}, "169": {"COUNTRY": "Tonga", "PAIS": "Tonga", "CAPITAL": "Nukualofa", "LAT": "-21,1385", "LON": "-175,2206", "MCC": 539}, "170": {"COUNTRY": "Trinidad and Tobago", "PAIS": "Trinidad y Tobago", "CAPITAL": "Port-of-Spain", "LAT": "10,652", "LON": "-61,517", "MCC": 374}, "171": {"COUNTRY": "Tunisia", "PAIS": "T\u00fanez", "CAPITAL": "Tunis", "LAT": "36,8028", "LON": "10,1797", "MCC": 605}, "172": {"COUNTRY": "Turkey", "PAIS": "Turqu\u00eda", "CAPITAL": "Ankara", "LAT": "39,9272", "LON": "32,8644", "MCC": 286}, "173": {"COUNTRY": "Turkmenistan", "PAIS": "Turkmenist\u00e1n", "CAPITAL": "Ashgabat", "LAT": "37,95", "LON": "58,3833", "MCC": 438}, "174": {"COUNTRY": "Tuvalu", "PAIS": "Tuvalu", "CAPITAL": "Funafuti", "LAT": "-8,5167", "LON": "179,2166", "MCC": 553}, "175": {"COUNTRY": "Uganda", "PAIS": "Uganda", "CAPITAL": "Kampala", "LAT": "0,3167", "LON": "32,5833", "MCC": 641}, "176": {"COUNTRY": "Ukraine", "PAIS": "Ucrania", "CAPITAL": "Kiev", "LAT": "50,4334", "LON": "30,5166", "MCC": 255}, "177": {"COUNTRY": "United Arab Emirates", "PAIS": "Emiratos \u00c1rabes", "CAPITAL": "Abu Dhabi", "LAT": "24,4667", "LON": "54,3666", "MCC": 424}, "178": {"COUNTRY": "United Kingdom", "PAIS": "Reino Unido", "CAPITAL": "London", "LAT": "51,5", "LON": "-0,1167", "MCC": 234}, "179": {"COUNTRY": "United States of America", "PAIS": "Estados Unidos", "CAPITAL": "Washington", "LAT": "38,9047", "LON": "-77,0163", "MCC": 310}, "180": {"COUNTRY": "Uruguay", "PAIS": "Uruguay", "CAPITAL": "Montevideo", "LAT": "-34,858", "LON": "-56,1711", "MCC": 748}, "181": {"COUNTRY": "Uzbekistan", "PAIS": "Uzbekist\u00e1n", "CAPITAL": "Tashkent", "LAT": "41,3117", "LON": "69,2949", "MCC": 434}, "182": {"COUNTRY": "Vanuatu", "PAIS": "Vanatu", "CAPITAL": "Port Vila", "LAT": "-17,7334", "LON": "168,3166", "MCC": 541}, "183": {"COUNTRY": "Vatican city", "PAIS": "Ciudad del Vaticano", "CAPITAL": "Vatican city", "LAT": "41,9026", "LON": "12,4539", "MCC": 225}, "184": {"COUNTRY": "Venezuela", "PAIS": "Venezuela", "CAPITAL": "Caracas", "LAT": "10,501", "LON": "-66,917", "MCC": 734}, "185": {"COUNTRY": "Vietnam", "PAIS": "Vietnam", "CAPITAL": "Hanoi", "LAT": "21,0333", "LON": "105,85", "MCC": 452}, "186": {"COUNTRY": "Yemen", "PAIS": "Yemen", "CAPITAL": "Sanaa", "LAT": "15,3547", "LON": "44,2066", "MCC": 421}, "187": {"COUNTRY": "Zambia", "PAIS": "Zambia", "CAPITAL": "Lusaka", "LAT": "-15,4166", "LON": "28,2833", "MCC": 645}, "188": {"COUNTRY": "Zimbabwe", "PAIS": "Zimbabue", "CAPITAL": "Harare", "LAT": "-17,8178", "LON": "31,0447", "MCC": 648}}', parse_int=int)
df_country = pd.DataFrame.from_dict(d1, orient='index')
df_country['LAT'] = df_country['LAT'].apply(lambda x: float(x.replace(',', '.')))
df_country['LON'] = df_country['LON'].apply(lambda x: float(x.replace(',', '.')))

# 2) Cargar, de la BBDD, los datos capturados
client = MongoClient("mongodb://"+args.u+":"+args.p+"@localhost:27017/lth_upna")
db = client["lth_upna"]

df_all = pd.DataFrame(columns=['MCC'])

for c in db.list_collection_names():
    if 'lth_/imsi_sensor/' in c and db[c].find({}).count() != 0:
        df = pd.DataFrame.from_dict(list(db[c].find({}, {'observation_time': True, 'entityId': True, '_id': False})), orient='columns')
        if maxFecha:
            if 'observation_time' in df and df['observation_time'].max() > maxFecha:
                maxFecha = df['observation_time'].max()
        else:
            if 'observation_time' in df:
                maxFecha = df['observation_time'].max()
        if 'entityId' in df:
            df = df[['entityId']]
            df.entityId = df.entityId.fillna(0)
            df = pd.DataFrame(data=df.entityId.unique(), columns=['IMSI'])
            df.IMSI = df.IMSI.apply(lambda x: str(x)[0:3])
            df.columns = ['MCC']
            df_all = df_all.append(df, sort=False)
        obtenerMapa(df, c.split("/")[-1])

# TODOS LOS SENSORES
obtenerMapa(df_all, None)